name: Fetch and Display Result

on:
  push:
    branches:
      - update/**

jobs:
  get_branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: List Branches
        id: list_branches
        run: |
          echo "BRANCHES=$( git ls-remote --heads origin | awk -F/ '$3 == "feature" && $5 == "base" {print $4}' | grep -E '^AAA-[0-9]+$' | tr '\n' ',')" >> $GITHUB_ENV

      - name: Send POST Requests
        run: |
          IFS=',' read -r -a branches <<< "$BRANCHES"
          for branch in "${branches[@]}"
          do
            curl -X POST https://api.github.com/repos/feelsodev/DrinkSomeWater/dispatches \
              -H 'Accept: application/vnd.github.v3+json' \
              -u ${{ secrets.GITHUB_TOKEN }} \
              -d '{"event_type": "feature-update", "client_payload": { "repository": "'"$branch"'" }}'
          done
